<style>
.debug_dump {
  font-size: 13px;
  color: #646c9a;
}
</style>

<% content_for :subheader_title do %>
Envio #<%= @shipment.shipment_number %>
<% end %>

<%= content_for :subheader_toolbar do %>

<% if @carrier && @carrier.shipment_menu_links.present? %>
  <div class="btn-group">
    <button type="button" class="btn btn-pill btn-outline-brand btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Opções
    </button>
    <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(86px, 33px, 0px);">
      <%= link_to "Imprimir etiqueta", get_labels_shipment_path(format: :pdf), class: "dropdown-item", target:"_blank" %>
      <%= link_to "Marcar como despachado", set_as_shipped_shipment_path, class: "dropdown-item", method:'post' %>
      <div class="dropdown-divider"></div>
      <%= link_to 'Informações adicionais', "#", class: "dropdown-item", "data-toggle" => "modal", 'data-target' => '#extraInfoModal' %>
      <% @carrier.shipment_menu_links.each do |text, path| %>
        <%= link_to text, path.gsub(/:id/,"#{@shipment.id}"), class: "dropdown-item", method: :post %>
      <% end %>
    </div>
  </div>
  <% end %>

  <%= link_to get_labels_shipment_path(@shipment, format: :pdf), class: "btn btn-sm btn-secondary btn-label-brand", target:'_blank' do %>
    <i class="la la-print"></i> Imprimir etiquetas
  <% end %>

  <%= link_to edit_shipment_path(@shipment), class: "btn btn-sm btn-elevate btn-brand btn-elevate" do %>
  Editar
  <% end %>
<% end %>

<!-- Modal de Informações Adicionais-->
<div class="modal fade" id="extraInfoModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Informações adicionais</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>×</span>
        </button>
      </div>
      <div class="modal-body">
        <%= ap(@shipment.settings,plain: true, indent: 0).html_safe %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-brand" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal do XML -->
<div class="modal fade" id="invoiceXmlModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">XML da Nota Fiscal</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>×</span>
        </button>
      </div>
      <div class="modal-body">
        <pre class="debug_dump">
          <%= Nokogiri::XML(@shipment.invoice_xml).to_xml(:indent => 2, :encoding => 'UTF-8') %>
        </pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-brand" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="kt-portlet">
      <div class="kt-portlet__head">
        <div class="kt-portlet__head-label">
          <h3 class="kt-portlet__head-title">
            Geral
          </h3>
        </div>
      </div>


      <div class="kt-portlet__body">
        <div class="kt-portlet__content">
          <table class="table table-borderless table-sm table-hover" style="color: #646c9a;">
            <tbody>
              <tr>
                <th>Status</th>
                <td><%= t @shipment.status %></td>
              </tr>
              <tr>
                <th>Número do pedido</th>
                <td><%= @shipment.order_number %></td>
              </tr>
              <tr>
                <th>Conta</th>
                <td><%= @shipment.account.name if @shipment.account %></td>
              </tr>
              <tr>
                <th>Transportadora</th>
                <td><%= link_to @carrier.display_name, edit_carrier_path(@carrier.id), class: "kt-link" if @carrier %></td>
              </tr>
              <tr>
                <th>Método de envio</th>
                <td><%= @shipment.shipping_method %></td>
              </tr>
              <tr>
                <th>Série da nota fiscal</th>
                <td><%= @shipment.invoice_series %></td>
              </tr>
              <tr>
                <th>Número da nota fiscal</th>
                <td><%= @shipment.invoice_number %></td>
              </tr>
              <tr>
                <th>Rastreamento</th>
                <td>
                  <% if @shipment.tracking_number.present? %>
                    <%= @shipment.tracking_number %>
                  <% else %>
                    <%= link_to "Obter rastreio", get_tracking_number_shipment_path, class: "kt-link" %>
                  <% end %>
                </td>
              </tr>
              <tr>
                <th>Nota Fiscal</th>
                <td><%= link_to 'Ver XML', "#", "data-toggle" => "modal", 'data-target' => '#invoiceXmlModal', class: "kt-link" %></td>
              </tr>
              <tr>
                <th>Sincronizado com a transportadora</th>
                <td>
                <% if @shipment.sent_to_carrier %>
                  Sim <i class="la la-check-circle"></i>
                <% else %>
                  <%= link_to "Enviar para a transportadora", send_to_carrier_shipment_path, class: "kt-link" , method:'post' %>
                <% end %>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <div class="col-md-6">
    <div class="kt-portlet kt-portlet--height-fluid">
      <div class="kt-portlet__head">
        <div class="kt-portlet__head-label">
          <h3 class="kt-portlet__head-title">
            Informações adicionais
          </h3>
        </div>
      </div>


      <div class="kt-portlet__body">
        <div class="kt-portlet__content">

        </div>
      </div>
    </div>
  </div>

</div>

<div class="row">
  <div class="col-md-6">

    <div class="kt-portlet kt-portlet--height-fluid">
      <div class="kt-portlet__head">
        <div class="kt-portlet__head-label">
          <h3 class="kt-portlet__head-title">
            Destinatário
          </h3>
        </div>
      </div>

      <div class="kt-portlet__body">
        <div class="kt-portlet__content">
          <%= render "recipient_address" %>
        </div>
      </div>
    </div>

  </div>
  <div class="col-md-6">

    <div class="kt-portlet kt-portlet--height-fluid">
      <div class="kt-portlet__head">
        <div class="kt-portlet__head-label">
          <h3 class="kt-portlet__head-title">
            Remetente
          </h3>
        </div>
      </div>

      <div class="kt-portlet__body">
        <div class="kt-portlet__content">
          <%= render "sender_address" %>
        </div>
      </div>
    </div>

  </div>

</div>

<div class="row">

  <div class="col-md-6">

    <% total_shipments = @shipment.packages.size %>
    <div class="row">

      <% @shipment.packages.each do |package| %>
      <div class="col-md-6">
        <div class="kt-portlet">
          <div class="kt-portlet__head">
            <div class="kt-portlet__head-label">
              <h3 class="kt-portlet__head-title">
                <i class="la la-cube"></i> Pacote <%= @shipment.packages.index(package) + 1 %>/<%= total_shipments %>
              </h3>
            </div>
            <div class="kt-portlet__head-toolbar">
              <%= link_to "Editar", edit_package_path(package), class: "float-right" %>
            </div>
          </div>
          <div class="kt-portlet__body">
            <div class="kt-portlet__content">
              <%= render 'packages/table', package: package %>
            </div>
          </div>
        </div>
      </div>

      <% end %>
    </div>


    <%= link_to new_package_path(shipment_id:@shipment.id), class: "p-5 btn btn-light btn-elevate-hover btn-square fill-div" do %>
    <i class="flaticon2-plus"></i> Novo pacote
    <% end %>
  </div>

  <div class="col-md-6">
    <div class="kt-portlet">
      <div class="kt-portlet__head">
        <div class="kt-portlet__head-label">
          <h3 class="kt-portlet__head-title">
            Histórico
          </h3>
        </div>
      </div>
      <div class="kt-portlet__body">
        <!--Begin::Timeline -->
        <div class="kt-timeline">
          <% @shipment.histories.each do |history| %>
            <%= render 'history', history: history %>
          <% end %>
        </div>
        <!--End::Timeline -->
      </div>
    </div>
  </div>
</div>
